<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>Amplify Sandbox</title>
	<script src="../../../external/jquery-1.4.4.js"></script>
	<script src="../../../store/amplify.store.js"></script>
	<script src="request.js"></script>
	<script>
	amplify.request.define( "cached", "ajax", {
		url: "simplejson.php",
		dataType: "json",
		cache: 10000,
		decoder: "jsend"
	});

	setInterval(function() {
		amplify.request( "cached", function( data ) {
			console.log( "cached", data.cached );
			console.log( data );
		});
	}, 4000 );

	// TODO: add cache settings for all storage types
	// e.g., cache: "sessionStorage"
	amplify.request.cache.persist = function( event, data ) {
		var resourceId = data.settings.resourceId,
			cacheKey = "request:" + resourceId,
			cacheValue = amplify.store( cacheKey );
		
		if ( cacheValue !== undefined ) {
//			data.ajaxSettings.success( cacheValue );
			data.ajaxSettings.success( $.extend({
				cached: true
			}, cacheValue ) );
			event.preventDefault();
		} else {
			var success = data.ajaxSettings.success;
			data.ajaxSettings.success = function( data ) {
				amplify.store( cacheKey, data );
				success.apply( this, arguments );
			};
		}
	};

	amplify.request.define( "pcached", "ajax", {
		url: "simplejson.php",
		dataType: "json",
		cache: "persist",
		decoder: "jsend"
	});

	setInterval(function() {
		amplify.request( "pcached", function( data ) {
			console.log( "pcached", data.cached );
			console.log( data );
		});
	}, 4000 );
	
	</script>
</head>
<body>
</body>
</html>
