<%args>
$tracking 
$key 
$debug => 1
</%args>

<%init>
#	https://store.2600hz.com/porting_form.html?tracking=2474&key=U2FsdGVkX1_vivdDPcImFQBhEvOI8vi0CZjOy6Gb2W2Iptm_cG8jEPacrxj3lEM77DxP2n2DB6rg8dbVuVkofQ
 $r->content_type('application/pdf') unless ($ARGS{debug});
my $wkhtmltopdf_path = '/public_html/bin/wkhtmltopdf-amd64'; 
 my $errs =[];
# get auth:

	my $aI = TS::checkKeyAuth($db, $errs, { key => MIME::Base64::URLSafe::decode($key) } );
	unless ($aI) {push(@$errs, {msg => 'Authentication failed!', type => 'error'}); 						$m->out(	JSON::XS->new->pretty(1)->allow_nonref->encode( {	errs => $errs,	args => \%ARGS	} )); return; }
	
	unless ($tracking =~m/^\d+$/) {push(@$errs, {msg => 'Invalid Tracking ID!', type => 'error'}); 						$m->out(	JSON::XS->new->pretty(1)->allow_nonref->encode( {	errs => $errs,	args => \%ARGS	} )); return; }
	
	my $cleanArgs={ 'tracking' => $tracking};
						if (ref $aI eq 'HASH')  { for my $k (keys %{$aI}) {
							$cleanArgs->{$k} = $aI->{$k};
						}	}


# grab status / get did

# match against key
	my $lnp = TS::getLNPData($db, [], $cleanArgs);

use URI::Escape::XS;


 my $verysafe='https://store.2600hz.com/lnp.html?';
 while (my ($k, $v) = each %ARGS) {
  $verysafe .= URI::Escape::XS::uri_escape($k) .'='. URI::Escape::XS::uri_escape($v) . '&';
}


if (0) {
	use Sudo;
  my $su;


  $su = Sudo->new(
                  {
                   sudo         => '/usr/local/bin/sudo',
                   sudo_args    => '',                                  
                   username     => 'root', 
                   password     => '91643770pbx',
                   program      => $wkhtmltopdf_path,
                   program_args => (qq{"$verysafe"},  "/tmp/ts/porting_pdfs/$tracking.pdf")
                  }
                 );
   
my  $result = $su->sudo_run();
  if (exists($result->{error})) 
     { 
       #&handle_error($result); 
     }
    else
     {
     	# should be JSON!!!
#     	my $json = $result->{stdout} =~m/^\s*{/ ? $result->{stdout} : {error => $result->{stderr}};
 #    	return JSON::XS::decode_json($json);
       printf "STDOUT: %s\n",$result->{stdout};
       printf "STDERR: %s\n",$result->{stderr} . $result->{error};
#       printf "return: %s\n",$result->{rc};
sleep 2;
	

		open PDF, '</tmp/ts/porting_pdfs/' . $tracking . '.pdf' or die $!;
		$m->out(<PDF>);
		close PDF;

     }
} else {
`$wkhtmltopdf_path "$verysafe"  "/tmp/ts/porting_pdfs/$tracking.pdf"`;
sleep 3;
	

		open PDF, '</tmp/ts/porting_pdfs/' . $tracking . '.pdf' or die $!;
		$m->out(<PDF>);
		close PDF;
		return;
}
</%init>
<pre><% qq{$wkhtmltopdf_path "$verysafe"  "/tmp/ts/porting_pdfs/$tracking.pdf" } %>
<& '/lnp.html' , %ARGS &>
$wkhtmltopdf_path "http://store.2600hz.com/lnp.html?tracking=2468&key=U2FsdGVkX18mBr1tul8dJtnD6VlbsMDdN7LWKs0yV7MtrL854WgnwZ8b4Lb8qcFsYYouPleFUhgDsaQdVFoexA&"  "/tmp/ts/porting_pdfs/24680.pdf" 
</pre>
